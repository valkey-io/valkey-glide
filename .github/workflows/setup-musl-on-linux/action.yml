name: Setup musl on Linux
description: "Sets up musl environment on Linux runners with special handling for ARM64, including repository cleanup and NPM configuration"

inputs:
    npm-scope:
        description: "npm scope"
        required: true
        # type: string
    npm-auth-token:
        description: "npm auth token"
        required: true
        # type: string
    arch:
        description: "architecture"
        required: false
        # options: ["x64", "arm64"]
        # type: string
        default: "arm64"

runs:
    using: "composite"
    steps:
        - name: Install dependencies
          shell: sh
          run: |
              apk update
              apk add bash git sed python3 redis

        # Currently "Checkout" action is not supported for musl on ARM64, so the checkout is happening on the runner and
        # here we just making sure we getting the clean repo
        - name: Clean repository for musl on ARM64
          shell: bash
          if: ${{ inputs.arch == 'arm64' }}
          run: |
              git config --global --add safe.directory $GITHUB_WORKSPACE
              git fetch origin ${{ github.sha }}
              git checkout ${{ github.sha }}
              git clean -xdf
              git reset --hard

        - name: Setup node
          if: ${{ inputs.arch == 'arm64' }}
          shell: bash
          working-directory: ./node
          env:
              NPM_AUTH_TOKEN: ${{ inputs.npm-auth-token }}
              NPM_SCOPE: ${{ inputs.npm-scope }}
          run: |
              npm config set registry https://registry.npmjs.org/
              npm config set '//registry.npmjs.org/:_authToken' "$NPM_AUTH_TOKEN"
              npm config set scope "$NPM_SCOPE"
