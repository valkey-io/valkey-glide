name: Install Rust and protoc
description: Install Rust toolchain and protobuf compiler

runs:
    using: "composite"
    steps:
        - name: Install Rust toolchain
          uses: dtolnay/rust-toolchain@stable
          with:
              components: rustfmt, clippy

        - name: Install protoc (protobuf)
          if: runner.os != 'Windows'
          uses: arduino/setup-protoc@v3
          with:
              repo-token: ${{ github.token }}

        - name: Install protoc (Windows)
          if: runner.os == 'Windows'
          shell: powershell
          run: |
              Write-Host "Installing protoc via Chocolatey..."
              
              if (Get-Command choco -ErrorAction SilentlyContinue) {
                  choco install protoc -y
                  
                  # Refresh PATH
                  $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User")
                  
                  # Verify installation
                  if (Get-Command protoc -ErrorAction SilentlyContinue) {
                      $version = protoc --version
                      Write-Host "protoc installed successfully: $version"
                  } else {
                      Write-Host "protoc installation may have failed"
                  }
              } else {
                  Write-Host "Chocolatey not available - cannot install protoc"
                  exit 1
              }

        - name: Verify Rust installation
          shell: powershell
          run: |
              Write-Host "Rust version:"
              rustc --version
              Write-Host "Cargo version:"
              cargo --version
              Write-Host "Rustfmt version:"
              rustfmt --version
              Write-Host "Clippy version:"
              cargo clippy --version

        - name: Verify protoc installation
          shell: powershell
          run: |
              Write-Host "Protoc version:"
              protoc --version
