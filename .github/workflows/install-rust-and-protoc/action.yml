name: Install Rust and protoc
description: Install Rust toolchain and protobuf compiler

runs:
    using: "composite"
    steps:
        - name: Install Rust toolchain (Windows)
          if: runner.os == 'Windows'
          shell: powershell
          run: |
              Write-Host "Installing Rust via Chocolatey..."
              
              if (Get-Command choco -ErrorAction SilentlyContinue) {
                  choco install rust -y
                  
                  # Refresh PATH
                  $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User")
                  
                  # Verify installation
                  if (Get-Command rustc -ErrorAction SilentlyContinue) {
                      $version = rustc --version
                      Write-Host "Rust installed successfully: $version"
                  } else {
                      Write-Host "Rust installation may have failed"
                      exit 1
                  }
              } else {
                  Write-Host "Chocolatey not available - cannot install Rust"
                  exit 1
              }

        - name: Install Rust toolchain (Unix)
          if: runner.os != 'Windows'
          uses: dtolnay/rust-toolchain@stable
          with:
              components: rustfmt, clippy

        - name: Install protoc (protobuf)
          if: runner.os != 'Windows'
          uses: arduino/setup-protoc@v3
          with:
              repo-token: ${{ github.token }}

        - name: Install protoc (Windows)
          if: runner.os == 'Windows'
          shell: powershell
          run: |
              Write-Host "Installing protoc via Chocolatey..."
              
              if (Get-Command choco -ErrorAction SilentlyContinue) {
                  choco install protoc -y
                  
                  # Refresh PATH
                  $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User")
                  
                  # Verify installation
                  if (Get-Command protoc -ErrorAction SilentlyContinue) {
                      $version = protoc --version
                      Write-Host "protoc installed successfully: $version"
                  } else {
                      Write-Host "protoc installation may have failed"
                  }
              } else {
                  Write-Host "Chocolatey not available - cannot install protoc"
                  exit 1
              }

        - name: Verify Rust installation (Windows)
          if: runner.os == 'Windows'
          shell: powershell
          run: |
              Write-Host "Rust version:"
              rustc --version
              Write-Host "Cargo version:"
              cargo --version
              Write-Host "Rustfmt version:"
              rustfmt --version
              Write-Host "Clippy version:"
              cargo clippy --version

        - name: Verify Rust installation (Unix)
          if: runner.os != 'Windows'
          shell: bash
          run: |
              echo "Rust version:"
              rustc --version
              echo "Cargo version:"
              cargo --version
              echo "Rustfmt version:"
              rustfmt --version
              echo "Clippy version:"
              cargo clippy --version

        - name: Verify protoc installation (Windows)
          if: runner.os == 'Windows'
          shell: powershell
          run: |
              Write-Host "Protoc version:"
              protoc --version

        - name: Verify protoc installation (Unix)
          if: runner.os != 'Windows'
          shell: bash
          run: |
              echo "Protoc version:"
              protoc --version
