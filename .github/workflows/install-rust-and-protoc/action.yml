name: Install Rust tool chain and protoc

inputs:
    target:
        description: "Specified target for rust toolchain, ex. x86_64-apple-darwin"
        type: string
        required: false
        default: "x86_64-unknown-linux-gnu"
        options:
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - x86_64-apple-darwin
            - aarch64-apple-darwin
            - x86_64-pc-windows-msvc
    github-token:
        description: "GitHub token"
        type: string
        required: true

runs:
    using: "composite"
    steps:
        - name: Install Rust toolchain (Windows)
          if: runner.os == 'Windows'
          shell: powershell
          run: |
              Write-Host "Installing Rust on Windows..."

              # Download and install rustup
              Invoke-WebRequest -Uri "https://win.rustup.rs/x86_64" -OutFile "$env:TEMP\rustup-init.exe"
              & "$env:TEMP\rustup-init.exe" -y --default-toolchain stable --target ${{ inputs.target }}

              # Add to PATH for current session
              $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"

              # Install components
              rustup component add rustfmt clippy

              # Verify installation
              rustc --version
              cargo --version

        - name: Install Rust toolchain (Linux/macOS)
          if: runner.os != 'Windows'
          uses: dtolnay/rust-toolchain@stable
          with:
              targets: ${{ inputs.target }}
              components: rustfmt, clippy

        - name: Install protoc (Linux/macOS)
          if: runner.os != 'Windows'
          uses: arduino/setup-protoc@v3

        - name: Install protoc (Windows)
          if: runner.os == 'Windows'
          shell: powershell
          run: |
              Write-Host "Installing protoc on Windows..."

              # Download protoc
              $url = "https://github.com/protocolbuffers/protobuf/releases/download/v25.1/protoc-25.1-win64.zip"
              $zipPath = "$env:TEMP\protoc.zip"
              $extractPath = "$env:TEMP\protoc"

              Invoke-WebRequest -Uri $url -OutFile $zipPath

              # Extract using .NET instead of Expand-Archive
              Add-Type -AssemblyName System.IO.Compression.FileSystem
              [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $extractPath)

              # Add to PATH
              $protocPath = "$extractPath\bin"
              echo "$protocPath" >> $env:GITHUB_PATH

              # Verify installation
              & "$protocPath\protoc.exe" --version
