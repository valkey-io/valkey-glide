name: Install shared software dependencies

inputs:
    os:
        description: "The current operating system"
        required: true
        type: string
        options:
            - amazon-linux
            - macos
            - ubuntu
            - windows
    target:
        description: "Specified target for rust toolchain, ex. x86_64-apple-darwin"
        type: string
        required: false
        defalt: "x86_64-unknown-linux-gnu"
        options:
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - x86_64-apple-darwin
            - aarch64-apple-darwin
            - aarch64-unknown-linux-musl
            - x86_64-unknown-linux-musl
            - x86_64-pc-windows-msvc
    engine-version:
        description: "Engine version to install"
        required: false
        type: string
    language:
        description: "The language being built (optional, for language-specific setup)"
        required: false
        type: string
    github-token:
        description: "GITHUB_TOKEN, GitHub App installation access token"
        required: true
        type: string

runs:
    using: "composite"
    steps:
        - name: Install software dependencies for macOS
          shell: bash
          if: "${{ inputs.os == 'macos' }}"
          run: |
              brew update
              brew install openssl coreutils

        - name: Install software dependencies for Ubuntu GNU
          shell: bash
          if: "${{ inputs.os == 'ubuntu' && !contains(inputs.target, 'musl')}}"
          run: |
              sudo apt update -y
              sudo apt install -y git gcc pkg-config openssl libssl-dev

        - name: Install software dependencies for MUSL
          shell: bash
          if: "${{ contains(inputs.target, 'musl') }}"
          run: |
              apk update
              wget -O - https://sh.rustup.rs | sh -s -- -y
              source "$HOME/.cargo/env"
              apk add protobuf-dev musl-dev make gcc envsubst openssl libressl-dev py3-pip

        - name: Install software dependencies for Amazon-Linux
          shell: bash
          if: "${{ inputs.os == 'amazon-linux' }}"
          run: |
              yum install -y gcc pkgconfig openssl openssl-devel which curl gettext libasan tar --allowerasing

        - name: Install software dependencies for Windows
          shell: pwsh
          if: "${{ inputs.os == 'windows' }}"
          run: |
              # Verify Rust toolchain is available
              rustc --version
              cargo --version

        - name: Setup Python for Windows
          if: "${{ inputs.os == 'windows' }}"
          uses: actions/setup-python@v5
          with:
              python-version: "3.x"

        - name: Setup WSL with Docker (Windows only)
          if: "${{ inputs.os == 'windows' && inputs.engine-version }}"
          uses: Vampire/setup-wsl@v6
          with:
              distribution: Ubuntu-22.04
              use-cache: true
              update: true
              additional-packages: build-essential git pkg-config libssl-dev python3 python3-pip docker.io

        - name: Setup Docker in WSL (Windows)
          if: "${{ inputs.os == 'windows' && inputs.engine-version }}"
          shell: bash
          run: |
              echo "=== Setting up Docker inside WSL ==="
              
              # Start Docker daemon in WSL with proper setup
              wsl -- bash -c "
                # Add user to docker group and apply immediately
                sudo usermod -aG docker \$USER
                
                # Create docker directory if it doesn't exist
                sudo mkdir -p /var/run
                
                # Start Docker daemon with proper permissions
                sudo dockerd --host=unix:///var/run/docker.sock --host=tcp://0.0.0.0:2375 --iptables=false > /tmp/docker.log 2>&1 &
                
                # Wait for Docker daemon to start
                echo 'Waiting for Docker daemon to start...'
                for i in {1..30}; do
                  if sudo docker info >/dev/null 2>&1; then
                    echo 'Docker daemon is running'
                    break
                  fi
                  echo \"Attempt \$i: Docker not ready yet, waiting...\"
                  sleep 2
                done
                
                # Test Docker with sudo first
                sudo docker --version
                sudo docker info
                
                # Build Valkey container using Ubuntu
                cd /mnt/d/a/valkey-glide/valkey-glide
                sudo docker build -f utils/Dockerfile.valkey-test --build-arg ENGINE_VERSION=${{ inputs.engine-version }} -t valkey-test-env utils/
                
                # Start long-running container
                sudo docker run -d --name valkey-test-container \
                  -v /mnt/d/a/valkey-glide/valkey-glide:/workspace \
                  -p 6379-55535:6379-55535 \
                  valkey-test-env tail -f /dev/null
                
                # Verify container is running
                sudo docker ps
                sudo docker exec valkey-test-container python3 --version
                sudo docker exec valkey-test-container valkey-server --version
                
                echo 'Docker setup complete in WSL'
              "
              
              echo "WSL Docker setup completed"



        - name: Start engine server
          shell: ${{ inputs.os == 'windows' && 'wsl-bash {0}' || 'bash' }}
          if: "${{ inputs.engine-version }}"
          env:
              OS_TYPE: ${{ inputs.os }}
              WSLENV: OS_TYPE
          run: |
              echo "Starting Valkey server"
              echo "OS_TYPE: '$OS_TYPE'"

              # Start Valkey server in background
              redis-server --daemonize yes --bind 0.0.0.0 --port 6379

              # For Windows, write IP to a file that PowerShell can read
              if [ "$OS_TYPE" = "windows" ]; then
                  hostname -I | awk '{print $1}' > /tmp/wsl_ip.txt
              fi

        - name: Install Rust toolchain and protoc
          if: "${{ !contains(inputs.target, 'musl') }}"
          uses: ./.github/workflows/install-rust-and-protoc
          with:
              target: ${{ inputs.target }}
              github-token: ${{ inputs.github-token }}

        - name: Install zig
          if: ${{ contains(inputs.target, 'linux-gnu') }}
          uses: ./.github/workflows/install-zig
          with:
              target: ${{ inputs.target }}
