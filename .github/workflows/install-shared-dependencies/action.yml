name: Install shared software dependencies

inputs:
    os:
        description: "The current operating system"
        required: true
        type: string
        options:
            - amazon-linux
            - macos
            - ubuntu
            - windows
    target:
        description: "Specified target for rust toolchain, ex. x86_64-apple-darwin"
        type: string
        required: false
        defalt: "x86_64-unknown-linux-gnu"
        options:
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - x86_64-apple-darwin
            - aarch64-apple-darwin
            - aarch64-unknown-linux-musl
            - x86_64-unknown-linux-musl
            - x86_64-pc-windows-msvc
    engine-version:
        description: "Engine version to install"
        required: false
        type: string
    language:
        description: "The language being built (optional, for language-specific setup)"
        required: false
        type: string
    github-token:
        description: "GITHUB_TOKEN, GitHub App installation access token"
        required: true
        type: string

runs:
    using: "composite"
    steps:
        - name: Install software dependencies for macOS
          shell: bash
          if: "${{ inputs.os == 'macos' }}"
          run: |
              brew update
              brew install openssl coreutils

        - name: Install software dependencies for Ubuntu GNU
          shell: bash
          if: "${{ inputs.os == 'ubuntu' && !contains(inputs.target, 'musl')}}"
          run: |
              sudo apt update -y
              sudo apt install -y git gcc pkg-config openssl libssl-dev

        - name: Install software dependencies for MUSL
          shell: bash
          if: "${{ contains(inputs.target, 'musl') }}"
          run: |
              apk update
              wget -O - https://sh.rustup.rs | sh -s -- -y
              source "$HOME/.cargo/env"
              apk add protobuf-dev musl-dev make gcc envsubst openssl libressl-dev py3-pip

        - name: Install software dependencies for Amazon-Linux
          shell: bash
          if: "${{ inputs.os == 'amazon-linux' }}"
          run: |
              sudo yum install -y gcc pkgconfig openssl openssl-devel which curl gettext libasan tar --allowerasing

        - name: Install software dependencies for Windows
          shell: pwsh
          if: "${{ inputs.os == 'windows' }}"
          run: |
              # Verify Rust toolchain is available
              rustc --version
              cargo --version

        - name: Setup Python for Windows
          if: "${{ inputs.os == 'windows' }}"
          uses: actions/setup-python@v5
          with:
              python-version: "3.x"

        - name: Setup WSL with Docker (Windows only)
          if: "${{ inputs.os == 'windows' && inputs.engine-version }}"
          uses: Vampire/setup-wsl@v6
          with:
              distribution: Ubuntu-22.04
              use-cache: true
              update: true
              additional-packages: docker.io

        - name: Setup Docker in WSL (Windows)
          if: "${{ inputs.os == 'windows' && inputs.engine-version }}"
          shell: pwsh
          run: |
              Write-Host "=== Setting up Docker inside WSL ==="
              
              # Stop Windows Docker daemon if running to avoid conflicts (ignore errors)
              net stop docker || echo "Windows Docker not running or already stopped"
              
              # Test WSL is working
              Write-Host "Testing WSL..."
              wsl -- echo "WSL is working"
              
              # Start Docker daemon in WSL with proper setup
              echo "Starting WSL Docker setup..."
              
              # Step 1: Test WSL
              wsl -- echo "WSL is working"
              
              # Step 2: Start Docker daemon in WSL
              Write-Host "Starting Docker daemon in WSL..."
              wsl -- bash -c "
                echo 'Killing any existing Docker processes...'
                pkill -f dockerd || true
                sleep 2
                
                echo 'Creating Docker directories...'
                mkdir -p /var/run /var/lib/docker
                
                echo 'Starting Docker daemon...'
                dockerd --host=unix:///var/run/docker.sock --dns=8.8.8.8 --dns=1.1.1.1 --data-root=/var/lib/docker &
                
                echo 'Waiting for Docker daemon to start...'
                for i in {1..30}; do
                  echo \"Attempt \$i: Testing Docker connection...\"
                  if docker info; then
                    echo 'Docker daemon is running!'
                    break
                  fi
                  sleep 2
                done
                
                echo 'Final Docker status check:'
                docker info || echo 'Docker daemon failed to start'
              "
              Start-Sleep 5
              
              # Step 3: Test Docker in WSL
              wsl -- docker info
              
              # Step 4: Pull Ubuntu image and create container
              Write-Host "Creating Valkey container..."
              wsl -- docker pull ubuntu:22.04
              
              # Step 5: Start container and install Valkey
              wsl -- docker run -d --name valkey-test-container --network host -v /mnt/d/a/valkey-glide/valkey-glide:/workspace ubuntu:22.04 bash -c "
                set -e
                apt-get update && 
                apt-get install -y python3 python3-pip build-essential git pkg-config libssl-dev wget &&
                cd /tmp &&
                wget -O valkey.tar.gz https://github.com/valkey-io/valkey/archive/refs/tags/${{ inputs.engine-version }}.tar.gz &&
                tar -xzf valkey.tar.gz &&
                cd valkey-${{ inputs.engine-version }} &&
                make -j`$(nproc) &&
                make install PREFIX=/usr/local &&
                /usr/local/bin/valkey-server --version &&
                cd / &&
                rm -rf /tmp/valkey* &&
                tail -f /dev/null
              "
              
              # Step 6: Wait and verify installation
              Write-Host "Waiting for Valkey installation..."
              Start-Sleep 60
              
              Write-Host "Verifying container and Valkey installation..."
              if (!(wsl -- docker ps | Select-String "valkey-test-container")) {
                  Write-Host "ERROR: Container is not running"
                  wsl -- docker logs valkey-test-container
                  exit 1
              }
              
              wsl -- docker exec valkey-test-container python3 --version
              wsl -- docker exec valkey-test-container /usr/local/bin/valkey-server --version
              
              Write-Host "WSL Docker setup completed"

        - name: Cache Valkey build (Non-Windows)
          if: "${{ inputs.engine-version && inputs.os != 'windows' }}"
          uses: actions/cache@v4
          id: cache-valkey
          with:
              path: |
                  valkey-cache/valkey-server
                  valkey-cache/valkey-cli
                  valkey-cache/valkey-benchmark
              key: valkey-${{ inputs.engine-version }}-${{ inputs.os }}-${{ inputs.target }}-${{ github.sha }}
              restore-keys: |
                  valkey-${{ inputs.engine-version }}-${{ inputs.os }}-${{ inputs.target }}-

        - name: Install engine (Non-Windows, Cached)
          shell: bash
          if: "${{ inputs.engine-version && inputs.os != 'windows' && steps.cache-valkey.outputs.cache-hit == 'true' }}"
          env:
              ENGINE_VERSION: ${{ inputs.engine-version }}
              OS_TYPE: ${{ inputs.os }}
          run: |
              echo "Using cached Valkey binaries"
              echo "OS_TYPE: '$OS_TYPE'"
              echo "ENGINE_VERSION: '$ENGINE_VERSION'"
              # Clone repo fresh
              git clone https://github.com/valkey-io/valkey.git
              cd valkey && git checkout "$ENGINE_VERSION"
              # Move cached binaries to correct location (force overwrite)
              mkdir -p src
              cp -f ../valkey-cache/* src/ 2>/dev/null || true
              # Install the cached binaries
              sudo make install

        - name: Build engine from source (Non-Windows)
          shell: bash
          if: "${{ inputs.engine-version && inputs.os != 'windows' && steps.cache-valkey.outputs.cache-hit != 'true' }}"
          env:
              ENGINE_VERSION: ${{ inputs.engine-version }}
              OS_TYPE: ${{ inputs.os }}
          run: |
              echo "Building Valkey from source"
              echo "OS_TYPE: '$OS_TYPE'"
              echo "ENGINE_VERSION: '$ENGINE_VERSION'"
              # Install dependencies (only needed on Linux, macOS uses brew)
              if [ "$OS_TYPE" = "ubuntu" ]; then
                  sudo apt install -y build-essential git pkg-config libssl-dev
              fi
              git clone https://github.com/valkey-io/valkey.git
              cd valkey && git checkout "$ENGINE_VERSION" && make -j$(nproc) BUILD_TLS=yes all
              # Cache the built binaries - detect which naming convention is used
              mkdir -p ../valkey-cache
              if [ -f "src/valkey-server" ]; then
                  echo "Found Valkey binaries"
                  cp -f src/valkey-server src/valkey-cli src/valkey-benchmark ../valkey-cache/ 2>/dev/null || true
              elif [ -f "src/redis-server" ]; then
                  echo "Found Redis binaries"
                  cp -f src/redis-server src/redis-cli src/redis-benchmark ../valkey-cache/ 2>/dev/null || true
              else
                  echo "Warning: No server binaries found to cache"
              fi
              # Install the binaries
              sudo make install



        - name: Start engine server (Non-Windows)
          shell: ${{ inputs.os == 'windows' && 'wsl-bash {0}' || 'bash' }}
          if: "${{ inputs.engine-version && inputs.os != 'windows' }}"
          env:
              ENGINE_VERSION: ${{ inputs.engine-version }}
              OS_TYPE: ${{ inputs.os }}
              WSLENV: ENGINE_VERSION:OS_TYPE
          run: |
              echo "Starting server for engine version $ENGINE_VERSION"
              echo "OS_TYPE: '$OS_TYPE'"

              # Determine which server binary to use based on version
              MAJOR_VERSION=$(echo "$ENGINE_VERSION" | cut -d. -f1)
              if [ "$MAJOR_VERSION" -lt 7 ]; then
                  SERVER_BINARY="redis-server"
                  echo "Using redis-server for version $ENGINE_VERSION"
              else
                  SERVER_BINARY="valkey-server"
                  echo "Using valkey-server for version $ENGINE_VERSION"
              fi

              # Start server in background
              $SERVER_BINARY --daemonize yes --bind 0.0.0.0 --port 6379

        - name: Install Rust toolchain and protoc
          if: "${{ !contains(inputs.target, 'musl') }}"
          uses: ./.github/workflows/install-rust-and-protoc
          with:
              target: ${{ inputs.target }}
              github-token: ${{ inputs.github-token }}

        - name: Install zig
          if: ${{ contains(inputs.target, 'linux-gnu') }}
          uses: ./.github/workflows/install-zig
          with:
              target: ${{ inputs.target }}
