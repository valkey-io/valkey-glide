# NodeJS wrapper

This package contains an internal package under the folder `rust-client`, which is just the Rust library and its auto-generated TypeSCript code. The external package, in this folder, contains all wrapping TypeSCript code and tests.

## Building

### dependency installation

Homebrew is the easiest way to install node, but you can choose any way you want to install it.
Npm should come as part as node. IMPORTANT - right now we support only npm major version 8.
The default install will be of version 9, so you'll need to downgrade - run `npm i -g npm@8`.

### Adding the babushka package to your package

Before you add the babushka package to your application, make sure to perform the stages in "[Building the wrapper](#building-the-wrapper)".
ATM Babushka isn't on npm, so you'll need to clone this repo to you device, and add the package using a folder path - `npm install <path to Babushka>/node`.

### Building the wrapper

Before you start, make sure that you have all dependencies mentioned [here](../README.md#development-pre-requirements), [rustup](../README.md#rustup), [node](../README.md#node-16-or-newer) installed, and all [submodules updated](../README.md#git-submodule).
Enter this folder in your terminal.
On the first install, run `npm i`, to install all dependencies. Also enter the `rust-client` folder, and run `npm i` there, too.

make sure that all dependencies, including rustup, have been installed.
Run `npm run build:release` runs a full build in release mode, stripped from all symbols. This might take a while.
Run `npm run build:benchmark` runs a fully optimized build with release symbols. This creates a larger binary than release build, but the binary can be profiled.

For testing purposes, you can run `npm run build` runs a full, unoptimized build.
If you've only made changes to the Rust code, run `npm run build-internal` to build the internal package and generates TypeSCript code.
If you've only made changes to the TypeScript code, run `npm run build-external` to build the external package without rebuilding the internal package.
Run `npm run build-protobuf` to generate node's protobuf files.

Once building completed, you'll find the compiled JavaScript code in the ./build-ts folder,

### Testing

Run `npm test` after building.

### [Optional] Manually compile protobuf files

1. Run `npm install protobufjs-cli` to install the JS protobuf command line utility
2. Generate static JS code `pbjs -t static-module -o ProtobufMessage.js ~/babushka/babushka-core/src/protobuf/*.proto`
3. Generates TypeSCript definitions from the compiled JS file `pbts -o ProtobufMessage.d.ts ProtobufMessage.js`
4. Due to a bug in the autogenerated files (see https://github.com/protobufjs/protobuf.js/issues/1063), manually replace `return this.encode(message, writer).ldelim();` to `return this.encode(message, writer && writer.len ? writer.fork() : writer).ldelim();` in the encodeDelimited functions of Request and Response under babushka/node/src/ProtobufMessage.js.

## Recommended VSCode extensions

[Prettier - Code formatter](https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode) -JavaScript / TypeScript formatter.
[Jest Runner](https://marketplace.visualstudio.com/items?itemName=firsttris.vscode-jest-runner) - in-editor test runner.
[Jest Test Explorer](https://marketplace.visualstudio.com/items?itemName=kavod-io.vscode-jest-test-adapter) - adapter to the VSCode testing UI.
[ESLint](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint) - linter.
