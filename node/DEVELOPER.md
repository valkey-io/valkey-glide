# Developer Guide

This document describes how to set up your development environment to build and test the **Valkey GLIDE Node wrapper**, part of the polyglot `valkey-glide` project.

## Project Structure

- `valkey-glide/`: The polyglot root directory.
- `valkey-glide/node/`: Contains the Node.js binding (TypeScript + Rust napi-rs).
    - `src/`: TypeScript source code with modular file organization.
        - `index.ts`: Main entry point that re-exports all APIs.
        - `BaseClient.ts`: Core client functionality.
        - `GlideClient.ts`: Standalone client implementation.
        - `GlideClusterClient.ts`: Cluster client implementation.
        - `Batch.ts`: Batching functionality.
        - `Commands.ts`: Command definitions and interfaces.
        - `Errors.ts`: Error types and handling.
        - `Logger.ts`: Logging functionality.
        - `server-modules/`: Server module implementations (e.g., JSON, FT).
        - `native.js`, `native.d.ts`: Auto-generated bindings by napi-rs.
    - `build-ts/`: Compiled TypeScript output.
    - `tests/`: Jest tests.
    - `rust-client/`: napi-rs Rust crate (binds to `glide-core`).
    - `npm/`: Platform-specific packages for CD.
        - Platform-specific directories (e.g., `linux-arm64-gnu/`, `darwin-x64/`) containing package.json and native binaries.
        - `glide/`: Main package directory created during the build process that re-exports TypeScript APIs.
- `valkey-glide/glide-core/`: The core Rust logic, shared across all language bindings.
- `.github/`: CI/CD workflows and composite actions.

## TypeScript Architecture

The Node.js wrapper uses a modular TypeScript architecture:

- **Entry Point**: The `index.ts` file serves as the main entry point, re-exporting all APIs.
- **Native Bridge**: The `native.js` and `native.d.ts` files are auto-generated by napi-rs during the build process.
- **Client Classes**:
    - `BaseClient.ts`: Shared client functionality.
    - `GlideClient.ts`: Standalone client implementation.
    - `GlideClusterClient.ts`: Cluster client implementation.
- **Commands & Batching**:
    - `Commands.ts`: Defines command interfaces and implementations.
    - `Batch.ts`: Batching functionality for efficient command execution.
- **Server Modules**:
    - `server-modules/GlideJson.ts`: JSON module integration.
    - `server-modules/GlideFt.ts`: Full-text search module integration.
    - `server-modules/GlideFtOptions.ts`: Options for full-text search module.

## Development Overview

The Node.js wrapper consists of:

- TypeScript: User-facing API organized in logical modules.
- Rust: Native module built with [`napi-rs`](https://github.com/napi-rs/napi-rs).
- Communication: Protocol Buffers for efficient data exchange.

## Build Modes

- **Fast Dev Build:**
  Quickly compiles without optimization. Best for testing and development.
  Command:

    ```bash
    npm run build
    ```

- **Benchmark Build:**
  Compiles optimized build, but install like dev build.
  Command:

    ```bash
    npm run build:benchmark
    ```

- **Release Build:**
  Fully optimized, stripped - This mimic production build.
  Command:

    ```bash
    npm run build:release
    ```

### Build Process Details

The build process consists of multiple steps:

1. `clean:build` - Removes previous build artifacts
2. `build-protobuf` - Generates optimized protobuf code (43% smaller than default)
3. `build:rust-client` - Builds the native Rust client binding
4. `build:ts` - Compiles TypeScript code into the build-ts directory

These steps are orchestrated by npm scripts in package.json.

## Prerequisites

- Node.js (see [supported version](https://github.com/valkey-io/valkey-glide/blob/main/node/README.md#nodejs-supported-version))
- npm
- Rust (via `rustup`)
- `protoc` (protobuf compiler)
- GCC, pkg-config, OpenSSL

### Installing Dependencies

#### On Ubuntu/Debian

```bash
sudo apt update
sudo apt install -y build-essential pkg-config libssl-dev protobuf-compiler
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

#### On macOS

```bash
brew install protobuf pkg-config openssl
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

### Installing Zig (for cross-compilation)

Zig is used to enable deterministic, static builds compatible with older glibc versions like 2.17.

#### On Ubuntu/Debian based systems

```bash
sudo apt install -y snap
sudo snap install zig --classic --beta
```

#### On macOS (with Homebrew)

```bash
brew install zig
```

Ensure `zig` is available in your PATH:

```bash
zig version
```

#### Node.js and npm

Install Node.js and npm from [nodejs.org](https://nodejs.org/) or via nvm:

```bash
nvm install --lts
nvm use --lts
```

Supported node version for development is minimum 18, but it is recomended to use one of lts versions, or latest.

Currently lts are 20 and 22, and latest is 23. 23 is short lived, and will be deprecated in

## Building & Running

1. Clone and set up:

    ```bash
    git clone https://github.com/valkey-io/valkey-glide.git
    cd valkey-glide/node
    npm install
    ```

2. Build:

    - Fast dev build:

        ```bash
        npm run build
        ```

    - Benchmark build:

        ```bash
        npm run build:benchmark
        ```

    - Release build:

        ```bash
        npm run build:release
        ```

3. Run tests:

    ```bash
    npm test
    ```

## Local Development Notes

- Rust builds are located in `node/rust-client/`. Scripts automatically `cd` into this directory when running `napi build`.
- TypeScript files are compiled into the `build-ts/` directory, maintaining the modular structure.
- The `index.ts` file re-exports all public APIs to maintain a clean interface.

## Linting & Formatting

### TypeScript

- Lint your TypeScript code using ESLint:

    ```bash
    npm run lint
    ```

- Automatically fix linting issues:

    ```bash
    npm run lint:fix
    ```

- Format code with Prettier:

    ```bash
    npm run format
    ```

### Rust

- Run Clippy linter:

    ```bash
    cd rust-client
    cargo clippy --all-features --all-targets -- -D warnings
    ```

- Format Rust code:

    ```bash
    cargo fmt
    ```

## Testing

- Jest configuration is in `node/jest.config.ts`.
- Tests are located in `node/tests/`.

Run tests with:

```bash
npm run test
```

Run tests in watch mode:

```bash
npm run test:watch
```

### Integration and Module Tests

The project includes different test groups:

```bash
# Run standard tests (excluding modules)
npm test

# Run tests with debugging options
npm run test:debug

# Run minimal tests (excludes modules and special features)
npm run test:minimum

# Run only module-specific tests
npm run test:modules
```

You can run these tests with custom flags for cluster and standalone endpoints by passing environment variables.

## REPL

You can experiment with the client in a live TypeScript REPL:

```bash
npx ts-node --project tsconfig.json
```

Examples:

```typescript
// When working in the project directory
import { GlideClient } from "./build-ts/index.js";
const client = await GlideClient.createClient({
    addresses: [{ host: "localhost", port: 6379 }],
});
await client.ping();
```

```typescript
// After installing the package
import { GlideClusterClient } from "@valkey/valkey-glide";
const cluster = await GlideClusterClient.createClient({
    addresses: [{ host: "localhost", port: 7000 }],
});
await cluster.ping();
```

## CI/CD Awareness

- CD workflow lives under `.github/workflows/npm-cd.yml`.
- Build system uses napi-rs CLI (`build`, `artifacts`, `prepublish`).
- Cross-compilation (glibc, musl, macOS) uses Zig for building platform-specific binaries.
- The CD workflow handles the modular TypeScript structure correctly.
- Artifacts are prepared and published automatically via the GitHub Actions pipeline.
- Package versioning is synchronized across all packages using the workflow inputs or git tag.
- The main package depends on platform-specific packages as optional dependencies, which are resolved based on the user's platform at installation time.

## Recommended VS Code Extensions

- Prettier
- ESLint
- Jest Runner
- rust-analyzer

## Troubleshooting

- **glide-rs not found:** Upgrade npm to >=9.4.2 if needed.
- **Build failures:** Check Rust and native build tools installation.
- **Protobuf errors:** Ensure `protoc` is installed and in PATH.
- **OpenSSL issues:** Verify OpenSSL development headers are installed (`libssl-dev` on Debian/Ubuntu).
- **Module import errors:** Ensure imports use `.js` extension in TypeScript files (e.g., `import { X } from './Y.js'`), as this is necessary for proper ESM resolution when TypeScript compiles to JavaScript modules. This is a standard requirement of TypeScript's ESM output, not a project-specific convention.
